<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <title>AR Navigation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />                  
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet" />
    <!-- A-Frame และ AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <!-- A-Frame Extras สำหรับคอมโพเนนต์ line -->
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif; 
            height: 100vh;
            overflow: hidden;
        }
        .container {
            display: none; /* ซ่อนทั้งสองตอนแรก */
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        .container.active {
            display: block;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            z-index: 2;
            width: calc(100% - 40px);
            max-width: 400px;
        }
        #controls input { 
            width: 70%; 
            padding: 5px; 
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        #controls button { 
            padding: 5px 10px; 
            margin-left: 5px; 
            border: none;
            background: #007BFF;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        #controls button:hover {
            background: #0056b3;
        }
        #dropdown {
            position: absolute;
            top: 50px;
            left: 10px;
            background: white;
            border-radius: 3px;
            box-shadow: 0px 0px 5px rgba(0,0,0,0.3);
            display: none;
            z-index: 2;
            width: calc(100% - 40px);
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
        }
        #dropdown div { 
            padding: 10px; 
            cursor: pointer; 
        }
        #dropdown div:hover { 
            background: #f0f0f0; 
        }
        /* ปรับแต่งแผนที่และ AR container */
        #map-container, #ar-container {
            width: 100%;
            height: 100%;
        }
        #map { width: 100%; height: 100%; }
        #ar-view {
            width: 100%;
            height: 100%;
        }
        /* ปุ่มกลับไปแผนที่ใน AR view */
        #back-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 3;
            display: none;
        }
        #back-button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <!-- ส่วนควบคุมการค้นหา -->
    <div id="controls" class="active">
        <input type="text" id="search-input" placeholder="ค้นหาสถานที่" />
        <button id="search-button">ค้นหา</button>
        <button id="clear-button">ล้าง</button>
    </div>
    <!-- Dropdown แสดงผลลัพธ์การค้นหา -->
    <div id="dropdown"></div>
    <!-- ปุ่มกลับไปแผนที่ -->
    <button id="back-button" onclick="switchToMap()">กลับไปแผนที่</button>
    <!-- แผนที่ -->
    <div id="map-container" class="active container">
        <div id="map"></div>
    </div>
    <!-- AR view -->
    <div id="ar-container" class="container">
        <a-scene embedded arjs>
            <a-marker preset="hiro">
                <!-- เส้นทาง AR จะถูกเพิ่มที่นี่ -->
            </a-marker>
            <a-entity camera></a-entity>
        </a-scene>
    </div>

    <script>
        // ตั้งค่า Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoiamFydWRhIiwiYSI6ImNtMDc5ZXViMDEzNGkya3NicGZzaGI1ZncifQ.N2tDCng_RYc0uCAymQ-LdA'; // แทนที่ด้วย Access Token ของคุณ
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [100.5018, 13.7563], // พิกัดเริ่มต้น (กรุงเทพฯ)
            zoom: 14
        });

        // เพิ่มปุ่มควบคุมการนำทาง
        map.addControl(new mapboxgl.NavigationControl());

        // สถานที่ตัวอย่าง
        var places = [
            { name: 'ลานจอดรถ ใกล้ศูนย์หนังสือ', coordinates: [100.19363458145814, 16.744872718523496], image: 'https://example.com/parking.png' },
            { name: 'ลานจอดรถ ใกล้โรงพยาบาล', coordinates: [100.18931709684061, 16.749730393172033], image: 'https://example.com/parking.png' },
            { name: 'ธนาคารกรุงไทย', coordinates: [100.1992812695405, 16.737478107656056], image: 'https://upload.wikimedia.org/wikipedia/th/2/29/%E0%B8%97%E0%B8%A2.png' },
            { name: 'ธนาคารกสิกรไทย', coordinates: [100.19899656512207, 16.736972925746034], image: 'https://upload.wikimedia.org/wikipedia/th/d/d6/KBANK.png' },
            // เพิ่มสถานที่เพิ่มเติมได้ที่นี่
        ];

        var dropdown = document.getElementById('dropdown');
        var markers = [];

        // ฟังก์ชันเพิ่มมาร์กเกอร์บนแผนที่
        function addMarkers() {
            places.forEach(function(place) {
                var marker = new mapboxgl.Marker()
                    .setLngLat(place.coordinates)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <h3>${place.name}</h3>
                        <img src="${place.image}" alt="${place.name}" style="width: 100%; height: auto;" />
                        <button style="margin-top: 10px;" onclick="navigateAR('${place.name}', [${place.coordinates[0]}, ${place.coordinates[1]}])">เส้นทาง AR</button>
                    `))
                    .addTo(map);
                markers.push(marker);
            });
        }

        addMarkers();

        // ฟังก์ชันค้นหาสถานที่
        document.getElementById('search-input').addEventListener('input', function() {
            var query = this.value.toLowerCase();
            if (query.trim() === '') {
                dropdown.style.display = 'none';
                return;
            }

            var filteredPlaces = places.filter(function(place) {
                return place.name.toLowerCase().includes(query);
            });

            dropdown.innerHTML = '';
            if (filteredPlaces.length > 0) {
                dropdown.style.display = 'block';
                filteredPlaces.forEach(function(place) {
                    var div = document.createElement('div');
                    div.textContent = place.name;
                    div.addEventListener('click', function() {
                        map.flyTo({ center: place.coordinates, zoom: 16 });
                        // ลบมาร์กเก่าทั้งหมดและเพิ่มมาร์กใหม่
                        markers.forEach(marker => marker.remove());
                        markers = [];
                        var newMarker = new mapboxgl.Marker()
                            .setLngLat(place.coordinates)
                            .setPopup(new mapboxgl.Popup().setHTML(`
                                <h3>${place.name}</h3>
                                <img src="${place.image}" alt="${place.name}" style="width: 100%; height: auto;" />
                                <button style="margin-top: 10px;" onclick="navigateAR('${place.name}', [${place.coordinates[0]}, ${place.coordinates[1]}])">เส้นทาง AR</button>
                            `))
                            .addTo(map);
                        markers.push(newMarker);
                        dropdown.style.display = 'none';
                    });
                    dropdown.appendChild(div);
                });
            } else {
                dropdown.style.display = 'none';
            }
        });

        // ฟังก์ชันล้างการค้นหา
        document.getElementById('clear-button').addEventListener('click', function() {
            markers.forEach(marker => marker.remove());
            markers = [];
            document.getElementById('search-input').value = '';
            dropdown.style.display = 'none';
            addMarkers();
        });

        // ฟังก์ชันการนำทาง AR
        function navigateAR(placeName, coordinates) {
            // ตรวจสอบตำแหน่งปัจจุบันของผู้ใช้
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var userCoordinates = [position.coords.longitude, position.coords.latitude];

                    // ส่งคำขอไปยัง Mapbox Directions API เพื่อสร้างเส้นทาง
                    var directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/walking/${userCoordinates.join(',')};${coordinates.join(',')}?geometries=geojson&access_token=${mapboxgl.accessToken}`;

                    fetch(directionsRequest)
                        .then(response => response.json())
                        .then(data => {
                            if (data.routes.length === 0) {
                                alert('ไม่พบเส้นทาง');
                                return;
                            }
                            var route = data.routes[0].geometry.coordinates; // พิกัดเส้นทาง

                            // เก็บข้อมูลเส้นทางใน sessionStorage
                            sessionStorage.setItem('arRoute', JSON.stringify(route));
                            sessionStorage.setItem('destinationName', placeName);

                            // สลับไปยัง AR view
                            switchToAR();
                            // แสดงเส้นทางใน AR
                            showAR(route, placeName);
                        })
                        .catch(error => {
                            console.error('Error fetching directions:', error);
                            alert('เกิดข้อผิดพลาดในการดึงเส้นทาง');
                        });
                }, function(error) {
                    console.error('Geolocation error:', error);
                    alert('ไม่สามารถรับตำแหน่งของคุณได้');
                });
            } else {
                alert('เบราว์เซอร์ของคุณไม่รองรับ Geolocation');
            }
        }

        // ฟังก์ชันสลับไปยัง AR view
        function switchToAR() {
            document.getElementById('map-container').classList.remove('active');
            document.getElementById('ar-container').classList.add('active');
            document.getElementById('back-button').style.display = 'block';
            document.getElementById('controls').style.display = 'none';
        }

        // ฟังก์ชันสลับกลับไปยังแผนที่
        function switchToMap() {
            document.getElementById('ar-container').classList.remove('active');
            document.getElementById('map-container').classList.add('active');
            document.getElementById('back-button').style.display = 'none';
            document.getElementById('controls').style.display = 'block';
            // ล้างเส้นทางใน AR
            clearAR();
        }

        // ฟังก์ชันแสดงเส้นทางใน AR
        function showAR(route, placeName) {
            // ล้างเส้นทางเก่าใน AR
            var scene = document.querySelector('a-scene');
            var existingRoute = document.getElementById('ar-route');
            if (existingRoute) {
                existingRoute.parentNode.removeChild(existingRoute);
            }

            // สร้างพิกัดใหม่สำหรับ AR (แปลงพิกัด GPS เป็นตำแหน่งใน AR)
            var startCoord = route[0];
            var arCoordinates = route.map(function(coord) {
                return [
                    (coord[0] - startCoord[0]) * 100, // แกน X
                    0,                                 // แกน Y (ความสูง)
                    (coord[1] - startCoord[1]) * 100  // แกน Z
                ];
            });

            // สร้างเส้นทางด้วยคอมโพเนนต์ path ของ aframe-extras
            var routeEntity = document.createElement('a-entity');
            routeEntity.setAttribute('id', 'ar-route');
            routeEntity.setAttribute('line', {
                start: `${arCoordinates[0][0]} ${arCoordinates[0][1]} ${arCoordinates[0][2]}`,
                end: `${arCoordinates[arCoordinates.length - 1][0]} ${arCoordinates[arCoordinates.length - 1][1]} ${arCoordinates[arCoordinates.length - 1][2]}`,
                color: '#FF0000',
                opacity: 0.8,
                linewidth: 5
            });

            // สร้างเส้นทางแบบต่อเนื่องด้วย path component
            routeEntity.setAttribute('path', {
                path: arCoordinates.map(coord => coord.join(' ')).join(','),
                color: '#FF0000',
                opacity: 0.8,
                linewidth: 5
            });

            // เพิ่มเส้นทางลงใน Scene AR
            scene.appendChild(routeEntity);

            // เพิ่มปุ่มกลับไปยังแผนที่ใน AR view (แสดงแล้วไม่ต้องเพิ่มซ้ำ)
            document.getElementById('back-button').style.display = 'block';

            alert(`เริ่มนำทางไปยัง ${placeName} ในโหมด AR`);
        }

        // ฟังก์ชันล้างเส้นทางใน AR
        function clearAR() {
            var scene = document.querySelector('a-scene');
            var existingRoute = document.getElementById('ar-route');
            if (existingRoute) {
                existingRoute.parentNode.removeChild(existingRoute);
            }
        }
    </script>
</body>
</html>


