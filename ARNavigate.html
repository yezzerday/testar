<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <title>AR Navigation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet" />
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r137/three.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif; 
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            z-index: 2;
            width: calc(100% - 40px);
            max-width: 400px;
        }
        #controls input { 
            width: 70%; 
            padding: 5px; 
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        #controls button { 
            padding: 5px 10px; 
            margin-left: 5px; 
            border: none;
            background: #007BFF;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        #controls button:hover {
            background: #0056b3;
        }
        #dropdown {
            position: absolute;
            top: 50px;
            left: 10px;
            background: white;
            border-radius: 3px;
            box-shadow: 0px 0px 5px rgba(0,0,0,0.3);
            display: none;
            z-index: 2;
            width: calc(100% - 40px);
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
        }
        #dropdown div { 
            padding: 10px; 
            cursor: pointer; 
        }
        #dropdown div:hover { 
            background: #f0f0f0; 
        }
        #map-container, #ar-container {
            width: 100%;
            height: 100%;
            display: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        #map-container.active, #ar-container.active {
            display: block;
        }
        #map { width: 100%; height: 100%; }
        #ar-view { width: 100%; height: 100%; }
        #back-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 15px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 3;
            display: none;
        }
        #back-button:hover {
            background: #0056b3;
        }
        #ar-button {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- ส่วนควบคุมการค้นหา -->
    <div id="controls" class="active">
        <input type="text" id="search-input" placeholder="ค้นหาสถานที่" />
        <button id="search-button">ค้นหา</button>
        <button id="clear-button">ล้าง</button>
    </div>
    <!-- Dropdown แสดงผลลัพธ์การค้นหา -->
    <div id="dropdown"></div>
    <!-- ปุ่มนำทาง AR -->
    <button id="ar-button" style="display: none;">นำทาง AR</button>
    <!-- ปุ่มกลับไปแผนที่ -->
    <button id="back-button" onclick="switchToMap()">กลับไปแผนที่</button>
    <!-- แผนที่ -->
    <div id="map-container" class="active">
        <div id="map"></div>
    </div>
    <!-- AR view -->
    <div id="ar-container">
        <canvas id="ar-view"></canvas>
    </div>

    <script>
        // ตรวจสอบการสนับสนุน WebGL
        if (!window.WebGLRenderingContext) {
            alert("เบราว์เซอร์ของคุณไม่รองรับ WebGL ซึ่งจำเป็นสำหรับการใช้งานแอปพลิเคชันนี้");
        }

        // ตั้งค่า Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoiamFydWRhIiwiYSI6ImNtMDc5ZXViMDEzNGkya3NicGZzaGI1ZncifQ.N2tDCng_RYc0uCAymQ-LdA'; // แทนที่ด้วย Access Token ของคุณ
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [100.19424882682976, 16.74518953316748], // พิกัดเริ่มต้น (กรุงเทพฯ)
            zoom: 14
        });

        // เพิ่มปุ่มควบคุมการนำทาง
        map.addControl(new mapboxgl.NavigationControl());

        // สถานที่ตัวอย่าง
        var places = [
            { name: 'ลานจอดรถ ใกล้ศูนย์หนังสือ', coordinates: [100.19363458145814, 16.744872718523496], image: 'https://example.com/parking.png' },
            { name: 'ลานจอดรถ ใกล้โรงพยาบาล', coordinates: [100.18931709684061, 16.749730393172033], image: 'https://example.com/parking.png' },
            { name: 'ธนาคารกรุงไทย', coordinates: [100.1992812695405, 16.737478107656056], image: 'https://upload.wikimedia.org/wikipedia/th/2/29/%E0%B8%97%E0%B8%A2.png' },
            { name: 'ธนาคารกสิกรไทย', coordinates: [100.19899656512207, 16.736972925746034], image: 'https://upload.wikimedia.org/wikipedia/th/d/d6/KBANK.png' },
            // เพิ่มสถานที่เพิ่มเติมได้ที่นี่
        ];

        var dropdown = document.getElementById('dropdown');
        var arButton = document.getElementById('ar-button');
        var markers = [];

        // ฟังก์ชันเพิ่มมาร์กเกอร์บนแผนที่
        function addMarkers() {
            places.forEach(function(place) {
                var marker = new mapboxgl.Marker()
                    .setLngLat(place.coordinates)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <h3>${place.name}</h3>
                        <img src="${place.image}" alt="${place.name}" style="width: 100%; height: auto;" />
                        <button style="margin-top: 10px;" onclick="navigateAR('${place.name}', [${place.coordinates[0]}, ${place.coordinates[1]}])">นำทาง AR</button>
                    `))
                    .addTo(map);
                markers.push(marker);
            });
        }

        addMarkers();

        // ฟังก์ชันค้นหาสถานที่
        document.getElementById('search-input').addEventListener('input', function() {
            var query = this.value.toLowerCase();
            if (query.trim() === '') {
                dropdown.style.display = 'none';
                return;
            }

            var filteredPlaces = places.filter(function(place) {
                return place.name.toLowerCase().includes(query);
            });

            dropdown.innerHTML = '';
            if (filteredPlaces.length > 0) {
                dropdown.style.display = 'block';
                filteredPlaces.forEach(function(place) {
                    var div = document.createElement('div');
                    div.textContent = place.name;
                    div.addEventListener('click', function() {
                        map.flyTo({ center: place.coordinates, zoom: 16 });
                        // ลบมาร์กเก่าทั้งหมดและเพิ่มมาร์กใหม่
                        markers.forEach(marker => marker.remove());
                        markers = [];
                        var newMarker = new mapboxgl.Marker()
                            .setLngLat(place.coordinates)
                            .setPopup(new mapboxgl.Popup().setHTML(`
                                <h3>${place.name}</h3>
                                <img src="${place.image}" alt="${place.name}" style="width: 100%; height: auto;" />
                                <button style="margin-top: 10px;" onclick="navigateAR('${place.name}', [${place.coordinates[0]}, ${place.coordinates[1]}])">นำทาง AR</button>
                            `))
                            .addTo(map);
                        markers.push(newMarker);
                        dropdown.style.display = 'none';
                    });
                    dropdown.appendChild(div);
                });
            } else {
                dropdown.style.display = 'none';
            }
        });

        // ฟังก์ชันล้างการค้นหา
        document.getElementById('clear-button').addEventListener('click', function() {
            markers.forEach(marker => marker.remove());
            markers = [];
            document.getElementById('search-input').value = '';
            dropdown.style.display = 'none';
            addMarkers();
        });

        // ฟังก์ชันการนำทาง AR
        function navigateAR(placeName, coordinates) {
            // ตรวจสอบตำแหน่งปัจจุบันของผู้ใช้
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var userCoordinates = [position.coords.longitude, position.coords.latitude];

                    // ส่งคำขอไปยัง Mapbox Directions API เพื่อสร้างเส้นทาง
                    var directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/walking/${userCoordinates.join(',')};${coordinates.join(',')}?geometries=geojson&access_token=${mapboxgl.accessToken}`;

                    fetch(directionsRequest)
                        .then(response => response.json())
                        .then(data => {
                            if (data.routes.length === 0) {
                                alert('ไม่พบเส้นทาง');
                                return;
                            }
                            var route = data.routes[0].geometry.coordinates; // พิกัดเส้นทาง

                            // เก็บข้อมูลเส้นทางใน sessionStorage (หากต้องการใช้ใน AR)
                            sessionStorage.setItem('arRoute', JSON.stringify(route));
                            sessionStorage.setItem('destinationName', placeName);

                            // แสดงปุ่มนำทาง AR
                            arButton.style.display = 'block';
                        })
                        .catch(error => {
                            console.error('Error fetching directions:', error);
                            alert('เกิดข้อผิดพลาดในการดึงเส้นทาง');
                        });
                }, function(error) {
                    console.error('Geolocation error:', error);
                    alert('ไม่สามารถรับตำแหน่งของคุณได้');
                });
            } else {
                alert('เบราว์เซอร์ของคุณไม่รองรับ Geolocation');
            }
        }

        // ฟังก์ชันสลับไปยัง AR view
        arButton.addEventListener('click', function() {
            // ซ่อนแผนที่และควบคุมการค้นหา
            document.getElementById('map-container').classList.remove('active');
            document.getElementById('controls').style.display = 'none';
            arButton.style.display = 'none';

            // แสดง AR view และปุ่มกลับ
            document.getElementById('ar-container').classList.add('active');
            document.getElementById('back-button').style.display = 'block';

            // ทำลาย Mapbox map เพื่อปลด WebGL context
            map.remove();

            // เริ่มต้น AR ด้วย WebXR และ Three.js
            initAR();
        });

        // ฟังก์ชันสลับกลับไปยังแผนที่
        function switchToMap() {
            // ซ่อน AR view และปุ่มกลับ
            document.getElementById('ar-container').classList.remove('active');
            document.getElementById('back-button').style.display = 'none';

            // แสดงแผนที่และควบคุมการค้นหา
            document.getElementById('map-container').classList.add('active');
            document.getElementById('controls').style.display = 'block';

            // สร้าง Mapbox map ใหม่
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [100.5018, 13.7563], // พิกัดเริ่มต้น (กรุงเทพฯ)
                zoom: 14
            });

            // เพิ่มปุ่มควบคุมการนำทาง
            map.addControl(new mapboxgl.NavigationControl());

            // เพิ่มมาร์กเกอร์ใหม่
            addMarkers();

            // ล้างเส้นทางใน AR
            clearAR();
        }

        // ฟังก์ชันแสดงเส้นทางใน AR ด้วย WebXR และ Three.js
        function initAR() {
            // ตรวจสอบว่าเบราว์เซอร์รองรับ WebXR หรือไม่
            if (navigator.xr) {
                navigator.xr.requestSession('immersive-ar').then(onSessionStarted);
            } else {
                alert('เบราว์เซอร์ของคุณไม่รองรับ WebXR AR');
            }
        }

        function onSessionStarted(session) {
            // ตั้งค่าการแสดงผลของ Three.js
            const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('ar-view'), alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.xr.setReferenceSpaceType('local');

            // สร้าง scene และ camera
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera();

            // สร้างเส้นทางจากข้อมูลที่เก็บใน sessionStorage
            const route = JSON.parse(sessionStorage.getItem('arRoute'));
            const destinationName = sessionStorage.getItem('destinationName');

            if (route && destinationName) {
                // แปลงพิกัด GPS เป็นตำแหน่งใน Three.js
                const startCoord = route[0];
                const arCoordinates = route.map(function(coord) {
                    return [
                        (coord[0] - startCoord[0]) * 100, // แกน X
                        0,                                 // แกน Y (ความสูง)
                        (coord[1] - startCoord[1]) * 100  // แกน Z
                    ];
                });

                // สร้างเส้นทาง
                const geometry = new THREE.BufferGeometry().setFromPoints(arCoordinates.map(coord => new THREE.Vector3(coord[0], coord[1], coord[2])));
                const material = new THREE.LineBasicMaterial({ color: 0xff0000 });
                const line = new THREE.Line(geometry, material);
                scene.add(line);

                // เพิ่มลูกศรที่ปลายเส้นทาง
                const arrowGeometry = new THREE.ConeGeometry(0.5, 1, 32);
                const arrowMaterial = new THREE.MeshBasicMaterial({ color: 0x0000ff });
                const arrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
                arrow.position.set(arCoordinates[arCoordinates.length - 1][0], arCoordinates[arCoordinates.length - 1][1], arCoordinates[arCoordinates.length - 1][2]);
                arrow.rotation.x = -Math.PI / 2; // ปรับการหมุนให้ชี้ไปในทิศทางที่ต้องการ
                scene.add(arrow);

                // แสดงชื่อสถานที่
                const loader = new THREE.FontLoader();
                loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', function (font) {
                    const textGeometry = new THREE.TextGeometry(destinationName, {
                        font: font,
                        size: 1,
                        height: 0.2,
                    });
                    const textMaterial = new THREE.MeshBasicMaterial({ color: 0x0000ff });
                    const textMesh = new THREE.Mesh(textGeometry, textMaterial);
                    textMesh.position.set(arCoordinates[arCoordinates.length - 1][0], arCoordinates[arCoordinates.length - 1][1] + 2, arCoordinates[arCoordinates.length - 1][2]);
                    scene.add(textMesh);
                });
            }

            // เริ่มต้น XR session
            session.requestReferenceSpace('local').then(function (refSpace) {
                renderer.xr.setReferenceSpace(refSpace);
                renderer.xr.setSession(session);
            });

            // สร้าง loop การ render
            function animate() {
                renderer.setAnimationLoop(function () {
                    renderer.render(scene, camera);
                });
            }

            animate();
        }

        // ฟังก์ชันล้างเส้นทางใน AR
        function clearAR() {
            // ในกรณีนี้ เราจะไม่สามารถล้าง AR scene ได้เพราะเราใช้ WebXR Session แยกต่างหาก
            // หากต้องการทำการเคลียร์ สามารถรีเซ็ต WebXR Session หรือสร้างใหม่
        }
    </script>
</body>
</html>

