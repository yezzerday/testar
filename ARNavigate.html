<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <title>AR Navigation</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/ar.js/3.2.0/aframe/build/aframe-ar.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        a-scene { height: 100vh; }
    </style>
</head>
<body>
    <a-scene embedded arjs>
        <a-marker preset="hiro">
            <a-entity id="path" line="color: blue; opacity: 0.5;"></a-entity>
            <a-entity 
                gltf-model="image/arrow.gltf" 
                scale="0.5 0.5 0.5" 
                position="0 0.1 0" 
                animation="property: position; to: 0 0.1 0.5; dir: alternate; dur: 1000; loop: true">
            </a-entity>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const destination = JSON.parse(localStorage.getItem('destination'));
        if (!destination) {
            alert('No destination set!'); 
            window.location.href = 'index.html'; 
        }

        // ตรวจสอบการเข้าถึงกล้อง
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(() => {
                console.log("Camera access granted.");
                navigator.geolocation.getCurrentPosition(position => {
                    const currentCoordinates = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    const accessToken = 'pk.eyJ1IjoiamFydWRhIiwiYSI6ImNtMDc5ZXViMDEzNGkya3NicGZzaGI1ZncifQ.N2tDCng_RYc0uCAymQ-LdA';
                    const directionsUrl = `https://api.mapbox.com/directions/v5/mapbox/driving/${currentCoordinates.lng},${currentCoordinates.lat};${destination.coordinates[0]},${destination.coordinates[1]}?geometries=geojson&access_token=${accessToken}`;
                    
                    console.log("Fetching directions...");
                    fetch(directionsUrl)
                        .then(response => {
                            console.log("Received response:", response);
                            return response.json();
                        })
                        .then(data => {
                            console.log("Directions data:", data);
                            const route = data.routes[0].geometry.coordinates;

                            const pathEntity = document.getElementById('path');
                            pathEntity.setAttribute('line', `points: ${route.map(point => point.join(' ')).join(', ')}; color: blue;`);
                            
                            const dx = destination.coordinates[0] - currentCoordinates.lng;
                            const dy = destination.coordinates[1] - currentCoordinates.lat;
                            const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                            document.querySelector('a-entity[gltf-model="image/arrow.gltf"]').setAttribute('rotation', `0 ${-angle} 0`);
                        })
                        .catch(error => console.error('Error fetching directions:', error));
                });
            })
            .catch(error => {
                console.error("Camera access denied:", error);
                alert("Please allow camera access.");
            });
    </script>
</body>
</html>

